<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>SheetSync OS</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#1e293b" />
    <link rel="apple-touch-icon" href="assets/icon.png" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Google Font: Inter -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Inter", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .modal {
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .modal-hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.95);
      }
      .modal-visible {
        opacity: 1;
        pointer-events: auto;
        transform: scale(1);
      }
      /* Skeleton Loader */
      .skeleton {
        background: linear-gradient(
          90deg,
          #1f2937 25%,
          #374151 50%,
          #1f2937 75%
        );
        background-size: 200% 100%;
        animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      @keyframes pulse {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
    </style>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body
    class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden"
  >
    <!-- HEADER -->
    <header
      class="bg-gray-800 border-b border-gray-700 p-4 z-10 flex justify-between items-center shrink-0"
    >
      <div class="flex items-center gap-3">
        <button
          id="btn-back"
          onclick="goHome()"
          class="hidden text-gray-400 hover:text-white"
        >
          <i class="fas fa-arrow-left text-lg"></i>
        </button>
        <div>
          <h1 id="app-title" class="text-xl font-bold tracking-tight">
            SheetSync
          </h1>
          <p id="status-indicator" class="text-xs text-gray-400">
            <i class="fas fa-circle text-[8px] mr-1"></i> Ready
          </p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button
          onclick="location.reload()"
          class="p-2 rounded-full hover:bg-gray-700 transition"
          title="Refresh App"
        >
          <i class="fas fa-rotate-right"></i>
        </button>
        <button
          id="btn-analytics"
          onclick="openAnalytics()"
          class="hidden p-2 rounded-full hover:bg-gray-700 transition"
          title="Analytics"
        >
          <i class="fas fa-chart-bar"></i>
        </button>
        <button
          id="btn-sheet-settings"
          onclick="openSheetSettings()"
          class="hidden p-2 rounded-full hover:bg-gray-700 transition"
          title="Sheet Settings"
        >
          <i class="fas fa-sliders-h"></i>
        </button>
        <button
          id="btn-app-settings"
          onclick="openSettings()"
          class="p-2 rounded-full hover:bg-gray-700 transition"
          title="App Settings"
        >
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main
      id="main-container"
      class="flex-1 overflow-y-auto no-scrollbar p-4"
    ></main>

    <!-- FAB (Floating Action Button) - Context Aware -->
    <button
      id="fab"
      onclick="handleFabClick()"
      class="fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl hover:bg-blue-700 active:scale-95 transition flex items-center justify-center text-2xl z-20"
    >
      <i class="fas fa-plus"></i>
    </button>

    <!-- GENERIC FORM MODAL -->
    <div
      id="form-modal"
      class="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center modal modal-hidden backdrop-blur-sm"
    >
      <div
        class="bg-gray-800 w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl border border-gray-700 max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 id="modal-title" class="text-lg font-bold text-white">Add New</h3>
          <button
            onclick="closeFormModal()"
            class="text-gray-400 hover:text-white"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <form
          id="dynamic-form"
          onsubmit="handleFormSubmit(event)"
          class="space-y-4"
        >
          <!-- Fields injected here -->
        </form>
      </div>
    </div>

    <!-- CREATE TRACKER MODAL -->
    <div
      id="create-tracker-modal"
      class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center modal modal-hidden backdrop-blur-sm"
    >
      <div
        class="bg-gray-800 w-11/12 max-w-sm rounded-2xl p-6 shadow-2xl border border-gray-700"
      >
        <h3 class="text-lg font-bold text-white mb-4">Create New Tracker</h3>

        <div class="space-y-4">
          <div>
            <label class="block text-xs font-semibold text-gray-400 mb-1"
              >Tracker Name</label
            >
            <input
              type="text"
              id="new-tracker-name"
              class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white outline-none focus:border-blue-500"
              placeholder="e.g. Gym Log"
            />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-400 mb-1"
              >Fields (Comma separated)</label
            >
            <input
              type="text"
              id="new-tracker-fields"
              class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white outline-none focus:border-blue-500"
              placeholder="e.g. Date, Exercise, Weight, Reps"
            />
            <p class="text-xs text-gray-500 mt-1">
              First field should usually be 'Date' or 'Name'
            </p>
          </div>

          <button
            onclick="createNewTracker()"
            class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold transition"
          >
            Create Tracker
          </button>
        </div>
      </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div
      id="settings-modal"
      class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center modal modal-hidden backdrop-blur-sm"
    >
      <div
        class="bg-gray-800 w-11/12 max-w-sm rounded-2xl p-6 shadow-2xl border border-gray-700"
      >
        <h3 class="text-lg font-bold text-white mb-2">Connect Google Sheet</h3>
        <p class="text-sm text-gray-400 mb-4">
          Paste the Web App URL from your Google Apps Script deployment.
        </p>

        <input
          type="url"
          id="inp-api-url"
          class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg mb-4 text-sm text-white focus:border-blue-500 outline-none"
          placeholder="https://script.google.com/macros/s/..."
        />

        <div class="mb-4">
          <label class="block text-xs font-semibold text-gray-400 mb-1"
            >Currency Symbol</label
          >
          <select
            id="inp-currency"
            class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-sm text-white outline-none"
          >
            <option value="‚Çπ">‚Çπ (INR)</option>
            <option value="$">$ (USD)</option>
            <option value="‚Ç¨">‚Ç¨ (EUR)</option>
            <option value="¬£">¬£ (GBP)</option>
            <option value="¬•">¬• (JPY)</option>
          </select>
        </div>

        <div class="flex justify-end gap-2">
          <button
            onclick="closeSettings()"
            class="px-4 py-2 text-gray-400 hover:text-white font-medium"
          >
            Cancel
          </button>
          <button
            onclick="saveSettings()"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700"
          >
            Save & Connect
          </button>
        </div>

        <div class="mt-6 pt-4 border-t border-gray-700">
          <button
            onclick="refreshSheetList()"
            class="w-full py-2 bg-gray-700 rounded text-sm mb-2 hover:bg-gray-600"
          >
            Re-fetch Sheet List
          </button>
          <button
            onclick="validateSchema()"
            class="w-full py-2 bg-green-900/50 border border-green-800 text-green-100 rounded text-sm mb-2 hover:bg-green-900"
          >
            Validate Schema (Check Headers)
          </button>
          <button
            onclick="localStorage.clear(); location.reload()"
            class="text-red-500 text-xs w-full text-center hover:underline"
          >
            Reset App
          </button>
        </div>
      </div>
    </div>

    <!-- SHEET SETTINGS MODAL -->
    <div
      id="sheet-settings-modal"
      class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center modal modal-hidden backdrop-blur-sm"
    >
      <div
        class="bg-gray-800 w-11/12 max-w-md max-h-[80vh] rounded-2xl shadow-2xl border border-gray-700 flex flex-col"
      >
        <div
          class="p-4 border-b border-gray-700 flex justify-between items-center shrink-0"
        >
          <h3 class="text-lg font-bold text-white">Sheet Settings</h3>
          <button
            onclick="closeSheetSettings()"
            class="text-gray-400 hover:text-white"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <div
          class="p-4 overflow-y-auto flex-1 no-scrollbar"
          id="sheet-settings-content"
        >
          <!-- Fields injected here -->
        </div>

        <div class="p-4 border-t border-gray-700 shrink-0">
          <button
            onclick="saveSheetSettings()"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold"
          >
            Save Settings
          </button>
        </div>
      </div>
    </div>

    <!-- ANALYTICS MODAL -->
    <div
      id="analytics-modal"
      class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center modal modal-hidden backdrop-blur-sm"
    >
      <div
        class="bg-gray-800 w-11/12 max-w-md max-h-[85vh] rounded-2xl shadow-2xl border border-gray-700 flex flex-col"
      >
        <div
          class="p-4 border-b border-gray-700 flex justify-between items-center shrink-0"
        >
          <h3 class="text-lg font-bold text-white">üìä Analytics</h3>
          <button
            onclick="closeAnalytics()"
            class="text-gray-400 hover:text-white"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <div
          class="p-4 overflow-y-auto flex-1 no-scrollbar"
          id="analytics-content"
        >
          <!-- Analytics injected here -->
        </div>
      </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
      // --- STATE ---
      // Helper for safe JSON parsing
      function safeParse(str, fallback) {
        try {
          return str ? JSON.parse(str) : fallback;
        } catch (e) {
          console.warn("JSON Parse Error", e);
          return fallback;
        }
      }

      // --- STATE ---
      let APP_ = {
        sheets: [], // List of available sheets {name, headers[]}
        currentSheet: null, // The active sheet object
        data: [], // Data for current sheet

        apiUrl: localStorage.getItem("sheetSync_url") || "",
        editingId: null, // Track currently editing item ID
        settings: safeParse(localStorage.getItem("sheetSync_settings"), {
          currency: "‚Çπ",
        }),
        // Per-sheet field settings: { sheetName: { fieldName: { inputType, options } } }
        fieldSettings: safeParse(
          localStorage.getItem("sheetSync_fieldSettings"),
          {}
        ),
      };

      // --- INIT ---
      window.addEventListener("load", async () => {
        if (!APP_.apiUrl) {
          openSettings();
        } else {
          // Load settings from cloud first
          await loadCloudSettings();
          loadMeta();
        }

        // Polling
        setInterval(() => {
          if (document.visibilityState === "visible" && APP_.currentSheet)
            loadData(APP_.currentSheet.name);
        }, 60000);
      });

      // Load settings from Google Sheets
      async function loadCloudSettings() {
        try {
          updateStatus("Loading settings...", "yellow-400");
          const res = await fetch(`${APP_.apiUrl}?action=get_settings`);
          const json = await res.json();

          if (json.status === "success" && json.data) {
            // Merge cloud settings with local
            if (json.data.fieldSettings) {
              APP_.fieldSettings = json.data.fieldSettings;
              localStorage.setItem(
                "sheetSync_fieldSettings",
                JSON.stringify(APP_.fieldSettings)
              );
            }
          }
        } catch (e) {
          console.log("Could not load cloud settings, using local:", e);
        }
      }

      // Save settings to Google Sheets
      async function saveCloudSettings() {
        try {
          await fetch(APP_.apiUrl, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
              action: "save_settings",
              data: {
                fieldSettings: APP_.fieldSettings,
              },
            }),
          });
        } catch (e) {
          console.log("Could not save cloud settings:", e);
        }
      }

      // --- ROUTING / VIEWS ---

      /* 1. DASHBOARD VIEW */
      function renderDashboard() {
        APP_.currentSheet = null;
        document.getElementById("btn-back").classList.add("hidden");
        document.getElementById("btn-sheet-settings").classList.add("hidden");
        document.getElementById("btn-analytics").classList.add("hidden");
        document.getElementById("btn-app-settings").classList.remove("hidden");
        document.getElementById("app-title").innerText = "SheetSync OS";

        const container = document.getElementById("main-container");
        container.innerHTML =
          '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 pb-20" id="app-grid"></div>';

        const grid = document.getElementById("app-grid");

        // Render App Cards
        APP_.sheets.forEach((sheet) => {
            const sheetSettings = APP_.fieldSettings[sheet.name] || {};
            
            // --- Determine Heuristics independently ---
            const lowerName = sheet.name.toLowerCase();
            let heuristicIcon = "fa-table";
            let heuristicColor = "gray"; // default key

            if (lowerName.includes("financ") || lowerName.includes("budget") || lowerName.includes("money")) {
                heuristicIcon = "fa-wallet";
                heuristicColor = "blue";
            } else if (lowerName.includes("habit") || lowerName.includes("daily") || lowerName.includes("routine")) {
                heuristicIcon = "fa-check-circle";
                heuristicColor = "green";
            } else if (lowerName.includes("gym") || lowerName.includes("workout") || lowerName.includes("fitness")) {
                heuristicIcon = "fa-dumbbell";
                heuristicColor = "orange";
            } else if (lowerName.includes("book") || lowerName.includes("read") || lowerName.includes("learn")) {
                heuristicIcon = "fa-book";
                heuristicColor = "purple";
            }

            // --- Resolve Final Icon ---
            // User setting > Heuristic > Default
            let finalIcon = sheetSettings._icon ? sheetSettings._icon.trim() : heuristicIcon;
            if (finalIcon && !finalIcon.startsWith("fa-")) {
                finalIcon = "fa-" + finalIcon;
            }

            // --- Resolve Final Color ---
            // User setting > Heuristic > Default
            let finalColorValue = sheetSettings._color ? sheetSettings._color.trim() : heuristicColor;
            
            // Map keys to Tailwind Gradients
            const colorMap = {
                "blue": "bg-gradient-to-br from-blue-900 to-blue-800 border-blue-700 text-blue-100",
                "green": "bg-gradient-to-br from-green-900 to-green-800 border-green-700 text-green-100",
                "red": "bg-gradient-to-br from-red-900 to-red-800 border-red-700 text-red-100",
                "purple": "bg-gradient-to-br from-purple-900 to-purple-800 border-purple-700 text-purple-100",
                "orange": "bg-gradient-to-br from-orange-900 to-orange-800 border-orange-700 text-orange-100",
                "gray": "bg-gradient-to-br from-gray-800 to-gray-900 border-gray-700 text-gray-200"
            };

            let containerClass = "";
            let containerStyle = "";

            if (colorMap[finalColorValue]) {
                // It's a preset key
                containerClass = colorMap[finalColorValue];
            } else if (finalColorValue.startsWith("#")) {
                // It's a Hex Code - Use generic base + inline style
                containerClass = "border-gray-700 text-white"; // fallback text color
                containerStyle = `background-color: ${finalColorValue}; border-color: ${finalColorValue};`;
            } else {
                // Fallback / Unknown text
                containerClass = colorMap["gray"];
            }

          const card = `
             <div onclick="openTracker('${sheet.name}')" 
                  class="${containerClass} p-4 rounded-2xl flex flex-col items-center justify-center gap-3 aspect-square active:scale-95 transition cursor-pointer shadow-lg hover:shadow-xl hover:border-gray-500 group"
                  style="${containerStyle}">
                <i class="fas ${finalIcon} text-3xl text-gray-200 group-hover:text-white transition"></i>
                <span class="font-semibold text-sm text-center text-gray-300 group-hover:text-white mix-blend-plus-lighter">${sheet.name}</span>
             </div>
           `;
          grid.insertAdjacentHTML("beforeend", card);
        });

        // "Add New" Card
        const addCard = `
           <div onclick="openCreateTrackerModal()" class="bg-gray-800 border-2 border-dashed border-gray-700 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 aspect-square active:scale-95 transition cursor-pointer hover:border-gray-500 hover:bg-gray-750">
                <i class="fas fa-plus text-2xl text-gray-500"></i>
                <span class="font-semibold text-sm text-center text-gray-500">New Tracker</span>
           </div>
        `;
        grid.insertAdjacentHTML("beforeend", addCard);

        // Hide FAB on dashboard (using card instead)
        document.getElementById("fab").classList.add("hidden");
      }

      /* 2. TRACKER VIEW */
      async function openTracker(sheetName) {
        const sheet = APP_.sheets.find((s) => s.name === sheetName);
        if (!sheet) return;

        APP_.currentSheet = sheet;

        // UI Updates
        document.getElementById("btn-back").classList.remove("hidden");
        document
          .getElementById("btn-sheet-settings")
          .classList.remove("hidden");
        document.getElementById("btn-analytics").classList.remove("hidden");
        document.getElementById("btn-app-settings").classList.add("hidden");
        document.getElementById("app-title").innerText = sheet.name;
        document.getElementById("fab").classList.remove("hidden");

        const container = document.getElementById("main-container");
        container.innerHTML = `
            <div id="tracker-stats" class="mb-4"></div>
            <div id="tracker-list" class="space-y-3 pb-24">
                ${renderSkeleton(6)}
            </div>
        `;

        // Fetch Data
        await loadData(sheetName);
      }

      function renderSkeleton(count) {
        let html = "";
        for (let i = 0; i < count; i++) {
          html += `
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-sm flex items-center justify-between">
               <div class="space-y-2 w-full mr-4">
                  <div class="h-4 bg-gray-700 rounded w-1/3 skeleton"></div>
                  <div class="h-3 bg-gray-700 rounded w-1/4 skeleton"></div>
               </div>
               <div class="h-8 w-8 bg-gray-700 rounded-lg skeleton shrink-0"></div>
            </div>`;
        }
        return html;
      }

      function renderTrackerData() {
        const container = document.getElementById("tracker-list");
        container.innerHTML = "";

        // Get sheet settings
        const sheetSettings = APP_.fieldSettings[APP_.currentSheet.name] || {};
        const sortOrder = sheetSettings._sortOrder || "newest";
        const textSize = sheetSettings._textSize || "normal";

        // Map text size to Tailwind class
        const textSizeClass =
          {
            normal: "text-lg",
            large: "text-xl",
            xlarge: "text-2xl",
          }[textSize] || "text-lg";

        // Special Case: Finance View (if headers match typical finance structure)
        const headers = APP_.currentSheet.headers.map((h) => h.toLowerCase());
        const isFinance =
          headers.includes("amount") &&
          (headers.includes("type") || headers.includes("category"));

        if (APP_.data.length === 0) {
          container.innerHTML =
            '<div class="text-center py-10 text-gray-500">No entries yet.</div>';
          return;
        }

        // Apply sorting
        let sortedData = [...APP_.data];
        const displayHeaders = APP_.currentSheet.headers.filter(
          (h) => h.toLowerCase() !== "id"
        );
        const firstCol = displayHeaders[0];

        if (sortOrder === "oldest") {
          sortedData.reverse();
        } else if (sortOrder === "asc" && firstCol) {
          sortedData.sort((a, b) =>
            String(a[firstCol] || "").localeCompare(String(b[firstCol] || ""))
          );
        } else if (sortOrder === "desc" && firstCol) {
          sortedData.sort((a, b) =>
            String(b[firstCol] || "").localeCompare(String(a[firstCol] || ""))
          );
        }
        // "newest" is default (data already reversed from API)

        // --- RENDER LOGIC ---
        sortedData.forEach((item, index) => {
          let html = "";

          if (isFinance) {
            // Specialized Finance Card
            const isExp = (item.type || "").toLowerCase() === "expense";
            const color = isExp ? "text-red-400" : "text-green-400";
            const sign = isExp ? "-" : "+";

            html = `
                    <div class="bg-gray-800 p-3 rounded-xl border border-gray-700 shadow-sm flex items-center justify-between">
                        <div>
                             <p class="font-bold ${textSizeClass} text-gray-200">${
              item.category || "Unknown"
            }</p>
                             <p class="text-xs text-gray-500">${formatDate(
                               item.date
                             )} ${item.note ? "‚Ä¢ " + item.note : ""}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <p class="font-bold ${color}">${sign}${
              APP_.settings.currency
            }${Number(item.amount).toLocaleString()}</p>
                            <button onclick="handleItemClick('${
                              item.id
                            }')" class="text-gray-400 hover:text-white p-2">
                                <i class="fas fa-pencil"></i>
                             </button>
                        </div>
                    </div>
                 `;
          } else {
            // Generic List Card
            // Filter out 'id' column for display, find primary columns
            const h = APP_.currentSheet.headers.filter(
              (col) => col.toLowerCase() !== "id"
            );
            const titleKey = h[0]; // First non-id column

            // Find a good subtitle key (skip toggle/dropdown fields)
            let subKey = null;
            for (let i = 1; i < h.length; i++) {
              const fieldSetting = sheetSettings[h[i]] || {};
              if (
                fieldSetting.inputType !== "toggle" &&
                fieldSetting.inputType !== "dropdown"
              ) {
                subKey = h[i];
                break;
              }
            }

            const valKey = h.length > 2 ? h[2] : null;

            // Helper to format value (apply formatDate if it looks like a date)
            const formatValue = (val) => {
              if (!val) return "";
              const str = String(val);
              // Check if it looks like an ISO date or date string
              if (str.includes("T") && str.includes("Z")) {
                return formatDate(val);
              }
              return str;
            };

            // Calculate majority status for toggle fields
            const toggleFields = Object.entries(sheetSettings).filter(
              ([k, v]) => v.inputType === "toggle"
            );
            let majorityIcon = "";
            if (toggleFields.length > 0) {
              let positiveCount = 0;
              let totalToggle = 0;
              toggleFields.forEach(([field, setting]) => {
                const itemValue = String(item[field] || "").trim();
                // Check if value contains checkmark (‚úÖ) - that's "done"
                if (itemValue.includes("‚úÖ")) {
                  positiveCount++;
                }
                totalToggle++;
              });
              // Majority means more than half are positive
              majorityIcon =
                positiveCount >= Math.ceil(totalToggle / 2) ? "‚úÖ" : "‚ùå";
            }

            html = `
                    <div class="bg-gray-800 p-3 rounded-xl border border-gray-700 shadow-sm flex items-center justify-between">
                        <div>
                             <p class="font-bold ${textSizeClass} text-gray-200">${
              formatValue(item[titleKey]) || "-"
            }</p>
                             ${
                               subKey
                                 ? `<p class="text-xs text-gray-500">${formatValue(
                                     item[subKey]
                                   )}</p>`
                                 : ""
                             }
                        </div>
                        <div class="flex items-center gap-3">
                             ${
                               majorityIcon
                                 ? `<span class="text-lg">${majorityIcon}</span>`
                                 : ""
                             }
                             <button onclick="handleItemClick('${
                               item.id
                             }')" class="text-gray-400 hover:text-white p-2">
                                <i class="fas fa-pencil"></i>
                             </button>
                        </div>
                    </div>
                 `;
          }
          container.insertAdjacentHTML("beforeend", html);
        });

        // Stats for finance
        if (isFinance) {
          const income = APP_.data
            .filter((i) => (i.type || "").toLowerCase() === "income")
            .reduce((s, i) => s + Number(i.amount), 0);
          const expense = APP_.data
            .filter((i) => (i.type || "").toLowerCase() === "expense")
            .reduce((s, i) => s + Number(i.amount), 0);

          document.getElementById("tracker-stats").innerHTML = `
               <div class="grid grid-cols-2 gap-3 mb-2">
                   <div class="bg-gray-800 p-3 rounded-xl border border-gray-700"><p class="text-xs text-gray-500 uppercase">Input</p><p class="text-lg font-bold text-green-400">${
                     APP_.settings.currency
                   }${income}</p></div>
                   <div class="bg-gray-800 p-3 rounded-xl border border-gray-700"><p class="text-xs text-gray-500 uppercase">Output</p><p class="text-lg font-bold text-red-400">${
                     APP_.settings.currency
                   }${expense}</p></div>
               </div>
               <div class="bg-gradient-to-r from-blue-900 to-gray-900 p-3 rounded-xl border border-blue-800 flex justify-between items-center">
                   <span class="text-blue-100 font-medium">Net Balance</span>
                   <span class="text-xl font-bold text-white">${
                     APP_.settings.currency
                   }${income - expense}</span>
               </div>
            `;
        } else {
          document.getElementById("tracker-stats").innerHTML = "";
        }
      }

      function goHome() {
        renderDashboard();
      }

      // --- DATA OPERATIONS ---

      async function loadMeta(skipRender = false) {
        updateStatus("Syncing Apps...", "yellow-400");
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 12000); // 12s timeout

        try {
          // 1. Get List of Sheets
          const res = await fetch(`${APP_.apiUrl}?action=get_sheets`, {
            signal: controller.signal,
          });
          clearTimeout(timeoutId);

          const json = await res.json();

          if (json.status === "success") {
            // VALIDATION: Check if response is from new backend
            if (
              Array.isArray(json.data) &&
              json.data.length > 0 &&
              !json.data[0].name
            ) {
              throw new Error(
                "Backend mismatch! Please Deploy a 'New Version' in Apps Script."
              );
            }

            APP_.sheets = json.data;
            localStorage.setItem("sheetSync_meta", JSON.stringify(APP_.sheets));

            if (!skipRender) {
              renderDashboard();
            }
            updateStatus("Ready", "green-400");
          } else {
            throw new Error(json.message || "Unknown API Error");
          }
        } catch (e) {
          console.error(e);
          updateStatus("Error", "red-400");

          let msg = e.message;
          if (e.name === "AbortError") msg = "Connection Timed Out";

          // Show visible alert for troubleshooting
          alert(
            `Connection Failed: ${msg}\n\nTip: Check Google Sheet permissions or 'Manage Deployments' > 'New Version'`
          );

          // Load from Cache if possible
          const cached = localStorage.getItem("sheetSync_meta");
          if (cached) {
            APP_.sheets = safeParse(cached, []);
            renderDashboard();
            updateStatus("Offline Mode", "gray-400");
          }
        }
      }

      async function loadData(sheetName) {
        updateStatus("Fetching Data...", "yellow-400");
        try {
          const res = await fetch(
            `${APP_.apiUrl}?action=read&sheet=${sheetName}`
          );
          const json = await res.json();
          if (json.status === "success") {
            // reverse for recent first
            APP_.data = json.data.reverse();
            renderTrackerData();
            updateStatus("Ready", "green-400");
          }
        } catch (e) {
          updateStatus("Offline (Read Error)", "red-400");
        }
      }

      async function createNewTracker() {
        const name = document.getElementById("new-tracker-name").value.trim();
        const fieldsStr = document
          .getElementById("new-tracker-fields")
          .value.trim();

        if (!name || !fieldsStr) return alert("Fill all fields");

        const headers = fieldsStr.split(",").map((s) => s.trim());
        // Always ensure 'id' represents a unique row if needed, but here user defines.
        // Ideally we might want to auto-inject 'id' or 'timestamp'.
        // For now, trust user.

        updateStatus("Creating Sheet...", "blue-400");
        document
          .getElementById("create-tracker-modal")
          .classList.add("modal-hidden");
        document
          .getElementById("create-tracker-modal")
          .classList.remove("modal-visible");

        try {
          const res = await fetch(APP_.apiUrl, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({
              action: "create_sheet",
              name: name,
              headers: headers,
            }),
          });

          // Wait a bit for propagation then reload
          setTimeout(() => {
            loadMeta();
            alert("Tracker created! It may take a few seconds to appear.");
          }, 2000);
        } catch (e) {
          alert("Error creating tracker: " + e.message);
        }
      }

      // --- DYNAMIC FORMS ---

      function handleFabClick() {
        if (!APP_.currentSheet) return;
        APP_.editingId = null; // Reset edit state
        buildForm(APP_.currentSheet.headers);
        document.getElementById("modal-title").innerText = "Add Entry";

        const m = document.getElementById("form-modal");
        m.classList.remove("modal-hidden");
        m.classList.add("modal-visible");
      }

      function handleItemClick(itemId) {
        if (!APP_.currentSheet) return;
        const item = APP_.data.find((d) => String(d.id) === String(itemId));
        if (!item) return;

        APP_.editingId = item.id;

        buildForm(APP_.currentSheet.headers, item);
        document.getElementById("modal-title").innerText = "Edit Entry";

        const m = document.getElementById("form-modal");
        m.classList.remove("modal-hidden");
        m.classList.add("modal-visible");
      }

      function buildForm(headers, existingData) {
        const form = document.getElementById("dynamic-form");
        form.innerHTML = "";

        if (!headers || headers.length === 0) {
          form.innerHTML = `<p class="text-red-400 text-center">No columns found. Please add headers to row 1 of your Google Sheet.</p>`;
          return;
        }

        headers.forEach((h) => {
          const lower = h.toLowerCase();
          if (lower === "id") return; // Skip ID

          const val = existingData ? existingData[h] || "" : "";
          let html = "";

          // Check field settings first
          const sheetSettings =
            APP_.fieldSettings[APP_.currentSheet.name] || {};
          const fieldSetting = sheetSettings[h] || {};
          let inputType = fieldSetting.inputType || "";
          const options = fieldSetting.options
            ? fieldSetting.options.split(",").map((o) => o.trim())
            : [];

          // Auto-infer type if not set
          if (!inputType) {
            if (lower.includes("date")) inputType = "date";
            else if (
              lower.includes("amount") ||
              lower.includes("price") ||
              lower.includes("cost") ||
              lower === "reps" ||
              lower === "sets"
            )
              inputType = "number";
            else inputType = "text";
          }

          // Validate inputType to be one of the allowed types
          if (
            !["text", "number", "date", "dropdown", "toggle"].includes(
              inputType
            )
          ) {
            inputType = "text";
          }

          // Render based on input type
          if (inputType === "dropdown" && options.length > 0) {
            const optionsHtml = options
              .map(
                (opt) =>
                  `<option value="${opt}" ${
                    val === opt ? "selected" : ""
                  }>${opt}</option>`
              )
              .join("");
            html = `
              <div>
                <label class="block text-xs font-semibold text-gray-400 mb-1 capitalize">${h}</label>
                <select name="${h}" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white outline-none">
                  ${optionsHtml}
                </select>
              </div>`;
          } else if (inputType === "toggle" && options.length >= 2) {
            const isFirst = !val || val === options[0];
            html = `
              <div>
                <label class="block text-xs font-semibold text-gray-400 mb-1 capitalize">${h}</label>
                <div class="flex gap-2">
                  <button type="button" data-field="${h}" data-value="${
              options[0]
            }" onclick="toggleField(this)" class="toggle-btn flex-1 p-3 rounded-lg font-medium transition ${
              isFirst ? "bg-blue-600 text-white" : "bg-gray-700 text-gray-300"
            }">${options[0]}</button>
                  <button type="button" data-field="${h}" data-value="${
              options[1]
            }" onclick="toggleField(this)" class="toggle-btn flex-1 p-3 rounded-lg font-medium transition ${
              !isFirst ? "bg-blue-600 text-white" : "bg-gray-700 text-gray-300"
            }">${options[1]}</button>
                </div>
                <input type="hidden" name="${h}" value="${val || options[0]}">
              </div>`;
          } else if (inputType === "date") {
            let defaultValue = val;
            if (!defaultValue) {
              const now = new Date();
              const year = now.getFullYear();
              const month = String(now.getMonth() + 1).padStart(2, "0");
              const day = String(now.getDate()).padStart(2, "0");
              defaultValue = `${year}-${month}-${day}`;
            } else {
              const d = new Date(defaultValue);
              if (!isNaN(d)) {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, "0");
                const day = String(d.getDate()).padStart(2, "0");
                defaultValue = `${year}-${month}-${day}`;
              }
            }
            html = `
              <div>
                <label class="block text-xs font-semibold text-gray-400 mb-1 capitalize">${h}</label>
                <input type="date" name="${h}" value="${defaultValue}" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white outline-none focus:border-blue-500">
              </div>`;
          } else {
            // Standard text or number input
            html = `
              <div>
                <label class="block text-xs font-semibold text-gray-400 mb-1 capitalize">${h}</label>
                <input type="${inputType}" name="${h}" value="${val}" step="any" ${
              inputType === "text" ? "" : "required"
            } class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white outline-none focus:border-blue-500">
              </div>`;
          }

          form.insertAdjacentHTML("beforeend", html);
        });

        const btnText = existingData ? "Update Entry" : "Save Entry";

        let btnsHtml = `
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold mt-2 shadow-lg">${btnText}</button>
        `;

        if (existingData) {
          btnsHtml += `
                <button type="button" onclick="handleDelete('${existingData.id}')" class="w-full bg-red-900/50 border border-red-800 hover:bg-red-900 text-red-200 py-3 rounded-xl font-bold mt-3">
                    <i class="fas fa-trash mr-2"></i> Delete Entry
                </button>
            `;
        }

        form.insertAdjacentHTML("beforeend", btnsHtml);
      }

      async function handleDelete(id) {
        if (!confirm("Are you sure you want to delete this?")) return;

        // Optimistic UI
        APP_.data = APP_.data.filter((d) => d.id !== id);
        renderTrackerData();
        closeFormModal();
        updateStatus("Deleting...", "red-400");

        try {
          const res = await fetch(APP_.apiUrl, {
            method: "POST",
            body: JSON.stringify({
              action: "delete",
              sheet: APP_.currentSheet.name,
              id: id,
            }),
          });
          const json = await res.json();
          if (json.status === "success") {
            updateStatus("Deleted", "green-400");
          } else {
            alert("Delete failed: " + json.message);
            loadData(APP_.currentSheet.name); // Revert
          }
        } catch (e) {
          alert("Delete error: " + e.message);
        }
      }

      async function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = {};

        // Collect data
        APP_.currentSheet.headers.forEach((h) => {
          if (h.toLowerCase() === "id") {
            data[h] = APP_.editingId || crypto.randomUUID();
          } else {
            data[h] = formData.get(h);
          }
        });

        closeFormModal();

        // Optimistic UI
        if (APP_.editingId) {
          const idx = APP_.data.findIndex((d) => d.id === APP_.editingId);
          if (idx !== -1) APP_.data[idx] = data;
        } else {
          APP_.data.unshift(data);
        }

        renderTrackerData();

        // Sync
        updateStatus("Saving...", "blue-400");
        try {
          const action = APP_.editingId ? "update" : "add";
          const res = await fetch(APP_.apiUrl, {
            method: "POST",
            // mode: "no-cors", // Removed to see errors
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
              action: action,
              sheet: APP_.currentSheet.name,
              data: data,
            }),
          });

          const text = await res.text();
          let json = null;
          try {
            json = JSON.parse(text);
          } catch (e) {
            // If not JSON, it's likely an HTML error page (Auth/404)
            throw new Error(
              "Invalid Server Response. Check URL & Permissions. Response: " +
                text.substring(0, 50) +
                "..."
            );
          }

          if (json.status === "error") {
            throw new Error(json.message || "Unknown Server Error");
          }

          // Reconfirm
          setTimeout(() => loadData(APP_.currentSheet.name), 1000);
          updateStatus("Saved", "green-400");
        } catch (err) {
          console.error(err);
          alert("Error syncing: " + err.message);
          updateStatus("Error", "red-400");
        }
      }

      // --- HELPERS & MODALS ---
      function toggleField(btn) {
        const field = btn.dataset.field;
        const value = btn.dataset.value;
        const form = document.getElementById("dynamic-form");
        const hiddenInput = form.querySelector(`input[name="${field}"]`);
        if (hiddenInput) hiddenInput.value = value;

        // Update button styles
        const buttons = form.querySelectorAll(`[data-field="${field}"]`);
        buttons.forEach((b) => {
          if (b === btn) {
            b.classList.remove("bg-gray-700", "text-gray-300");
            b.classList.add("bg-blue-600", "text-white");
          } else {
            b.classList.remove("bg-blue-600", "text-white");
            b.classList.add("bg-gray-700", "text-gray-300");
          }
        });
      }

      function formatDate(dateValue) {
        if (!dateValue) return "";
        const d = new Date(dateValue);
        if (isNaN(d)) return dateValue; // Return as-is if not valid date
        const day = String(d.getDate()).padStart(2, "0");
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const year = d.getFullYear();
        return `${day}/${month}/${year}`; // DD/MM/YYYY
      }

      function updateStatus(text, color) {
        document.getElementById(
          "status-indicator"
        ).innerHTML = `<i class="fas fa-circle text-[8px] mr-1 text-${color}"></i> ${text}`;
      }
      function openSettings() {
        document.getElementById("inp-api-url").value = APP_.apiUrl;
        document.getElementById("inp-currency").value = APP_.settings.currency;
        const m = document.getElementById("settings-modal");
        m.classList.remove("modal-hidden");
        m.classList.add("modal-visible");
      }
      function closeSettings() {
        document
          .getElementById("settings-modal")
          .classList.remove("modal-visible");
        document.getElementById("settings-modal").classList.add("modal-hidden");
      }
      function saveSettings() {
        const url = document.getElementById("inp-api-url").value.trim();
        const currency = document.getElementById("inp-currency").value;

        if (!url) return alert("Please enter a valid API URL");

        if (
          !confirm(
            "Are you sure you want to save these settings? This will update your Google Sheet connection."
          )
        ) {
          return;
        }

        localStorage.setItem("sheetSync_url", url);

        APP_.settings.currency = currency;
        localStorage.setItem(
          "sheetSync_settings",
          JSON.stringify(APP_.settings)
        );

        APP_.apiUrl = url;
        closeSettings();
        loadMeta(); // Reload to apply changes
      }
      function refreshSheetList() {
        closeSettings();
        loadMeta();
      }
      function validateSchema() {
        if (!APP_.sheets || APP_.sheets.length === 0) {
          return alert("No sheets found to validate. Please connect first.");
        }

        let report = "Schema Validation Report:\n\n";
        let issues = 0;

        APP_.sheets.forEach((sheet) => {
          const headers = sheet.headers.map((h) => h.toLowerCase());
          const name = sheet.name;
          const missing = [];

          if (!headers.includes("id")) missing.push("'id' (Required)");

          // Check for 'date' in trackers
          if (!headers.some((h) => h.includes("date"))) {
            // Not strictly required but highly recommended
            // missing.push("'date' (Recommended)");
          }

          if (missing.length > 0) {
            issues++;
            report += `‚ùå [${name}]: Missing ${missing.join(", ")}\n`;
          } else {
            report += `‚úÖ [${name}]: OK\n`;
          }
        });

        if (issues === 0) {
          alert("All sheets look good! ‚úÖ");
        } else {
          alert(
            report + "\nPlease add these columns to Row 1 of your Google Sheet."
          );
        }
      }
      function closeFormModal() {
        document.getElementById("form-modal").classList.remove("modal-visible");
        document.getElementById("form-modal").classList.add("modal-hidden");
      }
      function openCreateTrackerModal() {
        const m = document.getElementById("create-tracker-modal");
        m.classList.remove("modal-hidden");
        m.classList.add("modal-visible");
      }

      // --- SHEET SETTINGS ---
      function openSheetSettings() {
        if (!APP_.currentSheet) return;

        const sheetName = APP_.currentSheet.name;
        const headers = APP_.currentSheet.headers.filter(
          (h) => h.toLowerCase() !== "id"
        );
        const settings = APP_.fieldSettings[sheetName] || {};
        const sortOrder = settings._sortOrder || "newest";
        const textSize = settings._textSize || "normal";

        const container = document.getElementById("sheet-settings-content");

        // Display settings section (sorting and text size)
        container.innerHTML = `
          <div class="mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
             <h4 class="text-sm font-bold text-white mb-3">Card Appearance</h4>
             <div class="grid grid-cols-2 gap-3">
                 <div>
                    <label class="block text-xs font-semibold text-gray-400 mb-1">Icon (FontAwesome)</label>
                    <input type="text" id="sheet-icon" value="${
                      settings._icon || ""
                    }" placeholder="fa-table" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg text-white text-sm">
                 </div>
                 <div>
                    <label class="block text-xs font-semibold text-gray-400 mb-1">Color Theme</label>
                    <div class="flex gap-2">
                       <input type="text" id="sheet-color" value="${settings._color || ''}" placeholder="blue or #RRGGBB" class="flex-1 p-2 bg-gray-800 border border-gray-600 rounded-lg text-white text-sm">
                       <input type="color" id="sheet-color-picker" value="${settings._color && settings._color.startsWith('#') ? settings._color : '#2563eb'}" class="w-10 h-10 p-0 border-0 rounded-lg overflow-hidden cursor-pointer">
                    </div>
                    <script>
                        document.getElementById('sheet-color-picker').addEventListener('input', (e) => {
                            document.getElementById('sheet-color').value = e.target.value;
                        });
                        document.getElementById('sheet-color').addEventListener('input', (e) => {
                           if(e.target.value.startsWith('#')) {
                               document.getElementById('sheet-color-picker').value = e.target.value;
                           }
                        });
                    </script>
                 </div>
             </div>
          </div>

          <div class="mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
            <h4 class="text-sm font-bold text-white mb-3">Display Settings</h4>
            
            <label class="block text-xs font-semibold text-gray-400 mb-1">Sort Order</label>
            <select id="sheet-sort-order" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg text-white text-sm mb-3">
              <option value="newest" ${
                sortOrder === "newest" ? "selected" : ""
              }>Newest First</option>
              <option value="oldest" ${
                sortOrder === "oldest" ? "selected" : ""
              }>Oldest First</option>
              <option value="asc" ${
                sortOrder === "asc" ? "selected" : ""
              }>A ‚Üí Z (by first column)</option>
              <option value="desc" ${
                sortOrder === "desc" ? "selected" : ""
              }>Z ‚Üí A (by first column)</option>
            </select>
            
            <label class="block text-xs font-semibold text-gray-400 mb-1">Text Size</label>
            <select id="sheet-text-size" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg text-white text-sm">
              <option value="normal" ${
                textSize === "normal" ? "selected" : ""
              }>Normal</option>
              <option value="large" ${
                textSize === "large" ? "selected" : ""
              }>Large</option>
              <option value="xlarge" ${
                textSize === "xlarge" ? "selected" : ""
              }>Extra Large</option>
            </select>
          </div>
          
          <div class="mb-4">
             <h4 class="text-sm font-bold text-white mb-2">Manage Columns</h4>
             <p class="text-xs text-gray-400 mb-4">Configure inputs or remove columns (Dangerous).</p>
          </div>
        `;

        headers.forEach((field) => {
          const fieldSetting = settings[field] || {
            inputType: "text",
            options: "",
          };
          const inputType = fieldSetting.inputType;
          const options = fieldSetting.options || "";

          const html = `
            <div class="mb-4 p-3 bg-gray-900 rounded-lg border border-gray-700 group">
              <div class="flex justify-between items-center mb-2">
                 <label class="block text-sm font-semibold text-white">${field}</label>
                 <button onclick="handleDeleteColumn('${field}')" class="text-red-900 hover:text-red-500 transition opacity-50 group-hover:opacity-100 p-1" title="Delete Column">
                    <i class="fas fa-trash"></i>
                 </button>
              </div>
              
              <select data-field="${field}" class="field-type-select w-full p-2 bg-gray-800 border border-gray-600 rounded-lg text-white text-sm mb-2">
                <option value="text" ${
                  inputType === "text" ? "selected" : ""
                }>Text Input</option>
                <option value="number" ${
                  inputType === "number" ? "selected" : ""
                }>Number Input</option>
                <option value="date" ${
                  inputType === "date" ? "selected" : ""
                }>Date Picker</option>
                <option value="dropdown" ${
                  inputType === "dropdown" ? "selected" : ""
                }>Dropdown</option>
                <option value="toggle" ${
                  inputType === "toggle" ? "selected" : ""
                }>Toggle (2 options)</option>
              </select>
              <input 
                type="text" 
                data-field-options="${field}" 
                value="${options}" 
                placeholder="Options (comma separated)"
                class="field-options w-full p-2 bg-gray-800 border border-gray-600 rounded-lg text-white text-sm ${
                  inputType === "dropdown" || inputType === "toggle"
                    ? ""
                    : "hidden"
                }"
              />
            </div>
          `;
          container.insertAdjacentHTML("beforeend", html);
        });

        // Add New Field Section
        const addHtml = `
            <div class="mt-6 pt-4 border-t border-gray-700">
               <label class="block text-xs font-semibold text-gray-400 mb-2">Add New Column</label>
               <div class="flex gap-2">
                  <input type="text" id="new-col-name" placeholder="Column Name" class="flex-1 p-2 bg-gray-800 border border-gray-600 rounded-lg text-white text-sm">
                  <button onclick="handleAddColumn()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-lg text-sm font-bold">
                     <i class="fas fa-plus"></i>
                  </button>
               </div>
            </div>
        `;
        container.insertAdjacentHTML("beforeend", addHtml);

        // Add event listeners to toggle options visibility
        container.querySelectorAll(".field-type-select").forEach((select) => {
          select.addEventListener("change", (e) => {
            const field = e.target.dataset.field;
            const optionsInput = container.querySelector(
              `[data-field-options="${field}"]`
            );
            if (e.target.value === "dropdown" || e.target.value === "toggle") {
              optionsInput.classList.remove("hidden");
            } else {
              optionsInput.classList.add("hidden");
            }
          });
        });

        const m = document.getElementById("sheet-settings-modal");
        m.classList.remove("modal-hidden");
        m.classList.add("modal-visible");
      }

      async function handleAddColumn() {
        const nameInput = document.getElementById("new-col-name");
        const name = nameInput.value.trim();
        if (!name) return alert("Enter a column name");

        const btn =
          event.currentTarget ||
          document.querySelector("button[onclick='handleAddColumn()']");
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        updateStatus("Adding Column...", "blue-400");
        try {
          const res = await fetch(APP_.apiUrl, {
            method: "POST",
            body: JSON.stringify({
              action: "add_column",
              sheet: APP_.currentSheet.name,
              name: name,
            }),
          });
          const json = await res.json();
          if (json.status === "success") {
            updateStatus("Added", "green-400");
            // Refresh meta but skip dashboard render
            await loadMeta(true);
            // Update reference to current sheet
            APP_.currentSheet = APP_.sheets.find(
              (s) => s.name === APP_.currentSheet.name
            );
            openSheetSettings(); // Re-render settings
          } else {
            alert("Error: " + json.message);
            updateStatus("Error", "red-400");
            btn.disabled = false;
            btn.innerHTML = originalText;
          }
        } catch (e) {
          alert(e.message);
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }

      async function handleDeleteColumn(name) {
        if (
          !confirm(
            `Are you sure you want to delete column '${name}'?\n\nTHIS CANNOT BE UNDONE. All data in this column will be lost forever.`
          )
        )
          return;

        const btn = event.currentTarget; // The trash button
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        updateStatus("Deleting Column...", "red-400");
        try {
          const res = await fetch(APP_.apiUrl, {
            method: "POST",
            body: JSON.stringify({
              action: "delete_column",
              sheet: APP_.currentSheet.name,
              name: name,
            }),
          });
          const json = await res.json();
          if (json.status === "success") {
            updateStatus("Deleted", "green-400");
            await loadMeta(true);
            APP_.currentSheet = APP_.sheets.find(
              (s) => s.name === APP_.currentSheet.name
            );
            openSheetSettings();
          } else {
            alert("Error: " + json.message);
            updateStatus("Error", "red-400");
            btn.disabled = false;
            btn.innerHTML = originalHtml;
          }
        } catch (e) {
          alert(e.message);
          btn.disabled = false;
          btn.innerHTML = originalHtml;
        }
      }

      function closeSheetSettings() {
        const m = document.getElementById("sheet-settings-modal");
        m.classList.remove("modal-visible");
        m.classList.add("modal-hidden");
      }

      function saveSheetSettings() {
        if (!APP_.currentSheet) return;

        const sheetName = APP_.currentSheet.name;
        const container = document.getElementById("sheet-settings-content");
        const settings = {};

        // Save display settings
        settings._sortOrder = document.getElementById("sheet-sort-order").value;
        settings._textSize = document.getElementById("sheet-text-size").value;
        settings._icon = document.getElementById("sheet-icon").value.trim();
        settings._color = document.getElementById("sheet-color").value;

        // Save field settings
        container.querySelectorAll(".field-type-select").forEach((select) => {
          const field = select.dataset.field;
          const inputType = select.value;
          const optionsInput = container.querySelector(
            `[data-field-options="${field}"]`
          );
          const options = optionsInput ? optionsInput.value : "";

          settings[field] = { inputType, options };
        });

        APP_.fieldSettings[sheetName] = settings;
        localStorage.setItem(
          "sheetSync_fieldSettings",
          JSON.stringify(APP_.fieldSettings)
        );

        closeSheetSettings();
        renderTrackerData(); // Refresh to apply new settings
        updateStatus("Saving to cloud...", "yellow-400");

        // Sync to Google Sheets
        saveCloudSettings().then(() => {
          updateStatus("Settings Saved", "green-400");
        });
      }

      // --- ANALYTICS ---
      let chartInstances = [];

      function openAnalytics() {
        if (!APP_.currentSheet || APP_.data.length === 0) {
          alert("No data to analyze");
          return;
        }

        const container = document.getElementById("analytics-content");
        const headers = APP_.currentSheet.headers.map((h) => h.toLowerCase());
        const isFinance =
          headers.includes("amount") &&
          (headers.includes("type") || headers.includes("category"));
        const sheetSettings = APP_.fieldSettings[APP_.currentSheet.name] || {};

        // Destroy old charts
        chartInstances.forEach((c) => c.destroy());
        chartInstances = [];

        // Basic stats
        const totalEntries = APP_.data.length;

        // Find date column
        const dateCol = APP_.currentSheet.headers.find((h) =>
          h.toLowerCase().includes("date")
        );
        let dateRange = "";
        if (dateCol) {
          const dates = APP_.data
            .map((d) => new Date(d[dateCol]))
            .filter((d) => !isNaN(d))
            .sort((a, b) => a - b);
          if (dates.length > 0) {
            dateRange = `${formatDate(dates[0])} - ${formatDate(
              dates[dates.length - 1]
            )}`;
          }
        }

        let html = `
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
               <div class="bg-gray-900 p-4 rounded-xl border border-gray-700">
                 <p class="text-xs text-gray-500 uppercase mb-1">Total Entries</p>
                 <p class="text-2xl font-bold text-white">${totalEntries}</p>
               </div>
               ${
                 dateRange
                   ? `
               <div class="bg-gray-900 p-4 rounded-xl border border-gray-700">
                 <p class="text-xs text-gray-500 uppercase mb-1">Range</p>
                 <p class="text-xs font-semibold text-gray-300">${dateRange}</p>
               </div>`
                   : ""
               }
            </div>
        `;

        // INJECTION POINTS FOR CHARTS
        if (isFinance) {
          html += `
             <div class="bg-gray-900 p-4 rounded-xl border border-gray-700">
                <canvas id="chart-finance-bar"></canvas>
             </div>
             <div class="bg-gray-900 p-4 rounded-xl border border-gray-700">
                <canvas id="chart-category-pie"></canvas>
             </div>
          `;
        } else {
          html += `
             <div class="bg-gray-900 p-4 rounded-xl border border-gray-700">
                <canvas id="chart-generic-bar"></canvas>
             </div>
          `;
        }

        html += `</div>`;
        container.innerHTML = html;

        const m = document.getElementById("analytics-modal");
        m.classList.remove("modal-hidden");
        m.classList.add("modal-visible");

        // RENDER CHARTS
        setTimeout(() => {
          if (isFinance) {
            renderFinanceCharts();
          } else {
            renderGenericCharts(sheetSettings, totalEntries);
          }
        }, 100);
      }

      function renderFinanceCharts() {
        const income = APP_.data
          .filter((i) => (i.type || "").toLowerCase() === "income")
          .reduce((s, i) => s + Number(i.amount || 0), 0);
        const expense = APP_.data
          .filter((i) => (i.type || "").toLowerCase() === "expense")
          .reduce((s, i) => s + Number(i.amount || 0), 0);

        // 1. Bar Chart (Income vs Expense)
        const ctxBar = document
          .getElementById("chart-finance-bar")
          .getContext("2d");
        chartInstances.push(
          new Chart(ctxBar, {
            type: "bar",
            data: {
              labels: ["Income", "Expense"],
              datasets: [
                {
                  label: "Amount",
                  data: [income, expense],
                  backgroundColor: ["#4ade80", "#f87171"],
                  borderRadius: 8,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                title: { display: true, text: "Cash Flow", color: "#9ca3af" },
              },
              scales: {
                y: { grid: { color: "#374151" }, ticks: { color: "#9ca3af" } },
                x: { grid: { display: false }, ticks: { color: "#9ca3af" } },
              },
            },
          })
        );

        // 2. Pie Chart (Categories)
        const categories = {};
        APP_.data.forEach((item) => {
          if ((item.type || "").toLowerCase() === "expense") {
            const cat = item.category || "Other";
            categories[cat] = (categories[cat] || 0) + Number(item.amount || 0);
          }
        });

        const ctxPie = document
          .getElementById("chart-category-pie")
          .getContext("2d");
        chartInstances.push(
          new Chart(ctxPie, {
            type: "doughnut",
            data: {
              labels: Object.keys(categories),
              datasets: [
                {
                  data: Object.values(categories),
                  backgroundColor: [
                    "#60a5fa",
                    "#a78bfa",
                    "#f472b6",
                    "#fbbf24",
                    "#34d399",
                    "#f87171",
                  ],
                  borderWidth: 0,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "right",
                  labels: { color: "#d1d5db", boxWidth: 12 },
                },
                title: {
                  display: true,
                  text: "Expenses by Category",
                  color: "#9ca3af",
                },
              },
            },
          })
        );
      }

      function renderGenericCharts(sheetSettings, totalEntries) {
        const toggleFields = Object.entries(sheetSettings).filter(
          ([k, v]) => v.inputType === "toggle"
        );

        const labels = [];
        const dataPoints = [];

        if (toggleFields.length > 0) {
          toggleFields.forEach(([field, setting]) => {
            const completed = APP_.data.filter((d) =>
              String(d[field] || "").includes("‚úÖ")
            ).length;
            const percent = Math.round((completed / totalEntries) * 100);
            labels.push(field);
            dataPoints.push(percent);
          });
        } else {
          // Fallback: Just show simple count by first dropdown if exists
          // Or just do nothing if no toggle fields
          document.getElementById("chart-generic-bar").parentElement.innerHTML =
            "<p class='text-gray-500 text-center text-sm'>Add 'Toggle' fields in Sheet Settings to visualize habits/completion rates.</p>";
          return;
        }

        const ctx = document
          .getElementById("chart-generic-bar")
          .getContext("2d");
        chartInstances.push(
          new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Completion %",
                  data: dataPoints,
                  backgroundColor: "#3b82f6",
                  borderRadius: 6,
                },
              ],
            },
            options: {
              indexAxis: "y",
              responsive: true,
              plugins: {
                legend: { display: false },
                title: {
                  display: true,
                  text: "Completion Rates",
                  color: "#9ca3af",
                },
              },
              scales: {
                x: {
                  min: 0,
                  max: 100,
                  grid: { color: "#374151" },
                  ticks: { color: "#9ca3af" },
                },
                y: { grid: { display: false }, ticks: { color: "#9ca3af" } },
              },
            },
          })
        );
      }

      function closeAnalytics() {
        const m = document.getElementById("analytics-modal");
        m.classList.remove("modal-visible");
        m.classList.add("modal-hidden");
      }
    </script>
  </body>
</html>
