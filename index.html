<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>SheetSync</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#2563eb" />
    <link
      rel="apple-touch-icon"
      href="https://cdn-icons-png.flaticon.com/512/2936/2936758.png"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Google Font: Inter -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Inter", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      /* Hide scrollbar for clean mobile look */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* Smooth modal transition */
      .modal {
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .modal-hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.95);
      }
      .modal-visible {
        opacity: 1;
        pointer-events: auto;
        transform: scale(1);
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">
    <!-- HEADER -->
    <header
      class="bg-blue-600 text-white p-4 shadow-md z-10 flex justify-between items-center shrink-0"
    >
      <div>
        <h1 class="text-xl font-bold tracking-tight">SheetSync</h1>
        <p id="status-indicator" class="text-xs text-blue-100 opacity-80">
          <i class="fas fa-circle text-[8px] mr-1"></i> Offline
        </p>
      </div>
      <button
        onclick="openSettings()"
        class="p-2 rounded-full hover:bg-blue-700 active:bg-blue-800 transition"
      >
        <i class="fas fa-cog"></i>
      </button>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 space-y-4">
      <!-- SUMMARY CARDS -->
      <div class="grid grid-cols-2 gap-3">
        <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
          <p class="text-xs text-gray-500 uppercase font-semibold">Income</p>
          <p class="text-lg font-bold text-green-600">
            ₹<span id="total-income">0</span>
          </p>
        </div>
        <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
          <p class="text-xs text-gray-500 uppercase font-semibold">Expense</p>
          <p class="text-lg font-bold text-red-500">
            ₹<span id="total-expense">0</span>
          </p>
        </div>
      </div>
      <div
        class="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-4 rounded-xl shadow-lg flex justify-between items-center"
      >
        <div>
          <p class="text-xs text-gray-300 uppercase font-semibold">Balance</p>
          <p class="text-2xl font-bold">₹<span id="total-balance">0</span></p>
        </div>
        <div class="bg-white/10 p-2 rounded-lg">
          <i class="fas fa-wallet text-xl"></i>
        </div>
      </div>

      <!-- TRANSACTIONS LIST -->
      <div>
        <h2
          class="text-sm font-semibold text-gray-500 mb-2 uppercase tracking-wide"
        >
          Recent Transactions
        </h2>
        <div id="transaction-list" class="space-y-3 pb-4">
          <!-- Items injected here by JS -->
          <div class="text-center py-10 text-gray-400">
            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
            <p>Loading data...</p>
          </div>
        </div>
      </div>
    </main>

    <!-- FAB (Floating Action Button) -->
    <button
      onclick="openAddModal()"
      class="fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl hover:bg-blue-700 active:scale-95 transition flex items-center justify-center text-2xl z-20"
    >
      <i class="fas fa-plus"></i>
    </button>

    <!-- ADD TRANSACTION MODAL -->
    <div
      id="add-modal"
      class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center modal modal-hidden backdrop-blur-sm"
    >
      <div
        class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-gray-800">New Transaction</h3>
          <button
            onclick="closeAddModal()"
            class="text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <form id="add-form" onsubmit="handleAdd(event)" class="space-y-4">
          <div class="grid grid-cols-2 gap-3">
            <button
              type="button"
              id="btn-expense"
              onclick="setType('Expense')"
              class="py-2 rounded-lg font-medium bg-red-100 text-red-600 border-2 border-red-500"
            >
              Expense
            </button>
            <button
              type="button"
              id="btn-income"
              onclick="setType('Income')"
              class="py-2 rounded-lg font-medium bg-gray-100 text-gray-500 border-2 border-transparent"
            >
              Income
            </button>
          </div>
          <input type="hidden" id="inp-type" value="Expense" />

          <div>
            <label class="block text-xs font-semibold text-gray-500 mb-1"
              >Amount</label
            >
            <input
              type="number"
              id="inp-amount"
              required
              class="w-full text-2xl font-bold p-2 border-b-2 border-gray-200 focus:border-blue-500 outline-none bg-transparent"
              placeholder="₹0"
            />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-500 mb-1"
              >Category</label
            >
            <select
              id="inp-category"
              class="w-full p-3 bg-gray-50 rounded-lg outline-none focus:ring-2 focus:ring-blue-100"
            >
              <option>Food</option>
              <option>Transport</option>
              <option>Shopping</option>
              <option>Bills</option>
              <option>Salary</option>
              <option>Other</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-500 mb-1"
              >Date</label
            >
            <input
              type="date"
              id="inp-date"
              required
              class="w-full p-3 bg-gray-50 rounded-lg outline-none"
            />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-500 mb-1"
              >Note (Optional)</label
            >
            <input
              type="text"
              id="inp-note"
              class="w-full p-3 bg-gray-50 rounded-lg outline-none"
              placeholder="What is this for?"
            />
          </div>

          <button
            type="submit"
            id="btn-save"
            class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-blue-700 active:scale-95 transition"
          >
            Save Transaction
          </button>
        </form>
      </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div
      id="settings-modal"
      class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center modal modal-hidden backdrop-blur-sm"
    >
      <div class="bg-white w-11/12 max-w-sm rounded-2xl p-6 shadow-2xl">
        <h3 class="text-lg font-bold text-gray-800 mb-2">
          Connect Google Sheet
        </h3>
        <p class="text-sm text-gray-500 mb-4">
          Paste the Web App URL from your Google Apps Script deployment.
        </p>

        <input
          type="url"
          id="inp-api-url"
          class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-sm"
          placeholder="https://script.google.com/macros/s/..."
        />

        <div class="flex justify-end gap-2">
          <button
            onclick="closeSettings()"
            class="px-4 py-2 text-gray-500 font-medium"
          >
            Cancel
          </button>
          <button
            onclick="saveSettings()"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium"
          >
            Save & Connect
          </button>
        </div>

        <div class="mt-6 pt-4 border-t border-gray-100">
          <button
            onclick="clearData()"
            class="text-red-500 text-xs font-medium w-full text-center"
          >
            Reset App Data
          </button>
        </div>
      </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
      // --- STATE ---
      let transactions = [];
      let API_URL = localStorage.getItem("sheetSync_url") || "";

      // --- DOM ELEMENTS ---
      const listEl = document.getElementById("transaction-list");
      const totalIncomeEl = document.getElementById("total-income");
      const totalExpenseEl = document.getElementById("total-expense");
      const totalBalanceEl = document.getElementById("total-balance");
      const statusEl = document.getElementById("status-indicator");

      // --- INIT ---
      window.addEventListener("load", () => {
        // Set default date to today
        document.getElementById("inp-date").valueAsDate = new Date();

        if (!API_URL) {
          openSettings();
        } else {
          loadLocalData(); // Show cached data immediately
          fetchData(); // Sync in background
        }

        // Auto-refresh when app comes to foreground
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") {
            console.log("App visible, refreshing...");
            fetchData();
          }
        });

        // Background polling every 60 seconds
        setInterval(() => {
          if (document.visibilityState === "visible") {
            console.log("Auto-refreshing...");
            fetchData();
          }
        }, 60000);

        // Register Service Worker
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker
            .register("./sw.js")
            .then((reg) => console.log("SW Registered"))
            .catch((err) => console.log("SW Fail", err));
        }
      });

      // --- DATA HANDLERS ---
      function loadLocalData() {
        const stored = localStorage.getItem("sheetSync_data");
        if (stored) {
          transactions = JSON.parse(stored);
          render();
        }
      }

      async function fetchData() {
        if (!API_URL) return;
        updateStatus("Syncing...", "yellow-400");

        try {
          const response = await fetch(`${API_URL}?action=read`);
          const json = await response.json();

          if (json.status === "success") {
            // Sort by date desc
            transactions = json.data.sort(
              (a, b) => new Date(b.date) - new Date(a.date)
            );
            localStorage.setItem(
              "sheetSync_data",
              JSON.stringify(transactions)
            );
            render();
            updateStatus("Online", "green-400");
          } else {
            throw new Error(json.message);
          }
        } catch (err) {
          console.error(err);
          updateStatus("Offline", "red-400");
        }
      }

      async function handleAdd(e) {
        e.preventDefault();
        if (!API_URL) return alert("Please set API URL in settings");

        const btn = document.getElementById("btn-save");
        const originalText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;

        const newTx = {
          id: crypto.randomUUID(),
          date: document.getElementById("inp-date").value,
          type: document.getElementById("inp-type").value,
          category: document.getElementById("inp-category").value,
          amount: document.getElementById("inp-amount").value,
          note: document.getElementById("inp-note").value,
        };

        // Optimistic UI Update
        transactions.unshift(newTx);
        render();
        closeAddModal();

        // Send to Server
        try {
          await fetch(API_URL, {
            method: "POST",
            mode: "no-cors", // Google Script quirk
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "add", data: newTx }),
          });

          // Reset Form
          document.getElementById("add-form").reset();
          document.getElementById("inp-date").valueAsDate = new Date();
          setType("Expense"); // Reset to default

          // Re-fetch to confirm sync
          setTimeout(fetchData, 1000);
        } catch (err) {
          alert("Saved locally only. Error syncing: " + err.message);
        } finally {
          btn.innerText = originalText;
          btn.disabled = false;
        }
      }

      // --- RENDERERS ---
      function render() {
        // Calculate Totals
        const income = transactions
          .filter((t) => t.type === "Income")
          .reduce((sum, t) => sum + Number(t.amount), 0);
        const expense = transactions
          .filter((t) => t.type === "Expense")
          .reduce((sum, t) => sum + Number(t.amount), 0);

        totalIncomeEl.innerText = income.toLocaleString("en-IN");
        totalExpenseEl.innerText = expense.toLocaleString("en-IN");
        totalBalanceEl.innerText = (income - expense).toLocaleString("en-IN");

        // Render List
        listEl.innerHTML = "";

        if (transactions.length === 0) {
          listEl.innerHTML = `<div class="text-center py-10 text-gray-400">No transactions found.</div>`;
          return;
        }

        transactions.forEach((t) => {
          const isExp = t.type === "Expense";
          const colorClass = isExp ? "text-red-500" : "text-green-600";
          const sign = isExp ? "-" : "+";
          const icon = getCategoryIcon(t.category);

          const html = `
                <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800 text-sm">${
                              t.category
                            }</p>
                            <p class="text-xs text-gray-400">${formatDate(
                              t.date
                            )} ${t.note ? "• " + t.note : ""}</p>
                        </div>
                    </div>
                    <p class="font-bold ${colorClass}">${sign}₹${Number(
            t.amount
          ).toLocaleString("en-IN")}</p>
                </div>
                `;
          listEl.insertAdjacentHTML("beforeend", html);
        });
      }

      // --- HELPERS ---
      function updateStatus(text, color) {
        statusEl.innerHTML = `<i class="fas fa-circle text-[8px] mr-1 text-${color}"></i> ${text}`;
      }

      function setType(type) {
        document.getElementById("inp-type").value = type;
        const btnExp = document.getElementById("btn-expense");
        const btnInc = document.getElementById("btn-income");

        if (type === "Expense") {
          btnExp.className =
            "py-2 rounded-lg font-medium bg-red-100 text-red-600 border-2 border-red-500 transition-all";
          btnInc.className =
            "py-2 rounded-lg font-medium bg-gray-100 text-gray-500 border-2 border-transparent transition-all";
        } else {
          btnExp.className =
            "py-2 rounded-lg font-medium bg-gray-100 text-gray-500 border-2 border-transparent transition-all";
          btnInc.className =
            "py-2 rounded-lg font-medium bg-green-100 text-green-600 border-2 border-green-500 transition-all";
        }
      }

      function getCategoryIcon(cat) {
        const map = {
          Food: "fa-utensils",
          Transport: "fa-bus",
          Shopping: "fa-shopping-bag",
          Bills: "fa-file-invoice",
          Salary: "fa-money-bill-wave",
          Other: "fa-tag",
        };
        return map[cat] || "fa-circle";
      }

      function formatDate(dateStr) {
        const d = new Date(dateStr);
        return d.toLocaleDateString("en-IN", {
          day: "numeric",
          month: "short",
        });
      }

      // --- MODAL CONTROLS ---
      function openAddModal() {
        const m = document.getElementById("add-modal");
        m.classList.remove("modal-hidden");
        m.classList.add("modal-visible");
      }
      function closeAddModal() {
        const m = document.getElementById("add-modal");
        m.classList.remove("modal-visible");
        m.classList.add("modal-hidden");
      }
      function openSettings() {
        document.getElementById("inp-api-url").value = API_URL;
        const m = document.getElementById("settings-modal");
        m.classList.remove("modal-hidden");
        m.classList.add("modal-visible");
      }
      function closeSettings() {
        const m = document.getElementById("settings-modal");
        m.classList.remove("modal-visible");
        m.classList.add("modal-hidden");
      }
      function saveSettings() {
        const url = document.getElementById("inp-api-url").value.trim();
        if (url) {
          localStorage.setItem("sheetSync_url", url);
          API_URL = url;
          closeSettings();
          fetchData();
        }
      }
      function clearData() {
        if (confirm("Clear all local data and settings?")) {
          localStorage.clear();
          window.location.reload();
        }
      }
    </script>
  </body>
</html>
