<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>SheetSync OS</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#1e293b" />
    <link
      rel="apple-touch-icon"
      href="https://cdn-icons-png.flaticon.com/512/2936/2936758.png"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Google Font: Inter -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Inter", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .modal {
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .modal-hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.95);
      }
      .modal-visible {
        opacity: 1;
        pointer-events: auto;
        transform: scale(1);
      }
    </style>
  </head>
  <body
    class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden"
  >
    <!-- HEADER -->
    <header
      class="bg-gray-800 border-b border-gray-700 p-4 z-10 flex justify-between items-center shrink-0"
    >
      <div class="flex items-center gap-3">
        <button
          id="btn-back"
          onclick="goHome()"
          class="hidden text-gray-400 hover:text-white"
        >
          <i class="fas fa-arrow-left text-lg"></i>
        </button>
        <div>
          <h1 id="app-title" class="text-xl font-bold tracking-tight">
            SheetSync
          </h1>
          <p id="status-indicator" class="text-xs text-gray-400">
            <i class="fas fa-circle text-[8px] mr-1"></i> Ready
          </p>
        </div>
      </div>
      <button
        onclick="openSettings()"
        class="p-2 rounded-full hover:bg-gray-700 transition"
      >
        <i class="fas fa-cog"></i>
      </button>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main
      id="main-container"
      class="flex-1 overflow-y-auto no-scrollbar p-4"
    ></main>

    <!-- FAB (Floating Action Button) - Context Aware -->
    <button
      id="fab"
      onclick="handleFabClick()"
      class="fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl hover:bg-blue-700 active:scale-95 transition flex items-center justify-center text-2xl z-20"
    >
      <i class="fas fa-plus"></i>
    </button>

    <!-- GENERIC FORM MODAL -->
    <div
      id="form-modal"
      class="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center modal modal-hidden backdrop-blur-sm"
    >
      <div
        class="bg-gray-800 w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl border border-gray-700"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 id="modal-title" class="text-lg font-bold text-white">Add New</h3>
          <button
            onclick="closeFormModal()"
            class="text-gray-400 hover:text-white"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <form
          id="dynamic-form"
          onsubmit="handleFormSubmit(event)"
          class="space-y-4"
        >
          <!-- Fields injected here -->
        </form>
      </div>
    </div>

    <!-- CREATE TRACKER MODAL -->
    <div
      id="create-tracker-modal"
      class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center modal modal-hidden backdrop-blur-sm"
    >
      <div
        class="bg-gray-800 w-11/12 max-w-sm rounded-2xl p-6 shadow-2xl border border-gray-700"
      >
        <h3 class="text-lg font-bold text-white mb-4">Create New Tracker</h3>

        <div class="space-y-4">
          <div>
            <label class="block text-xs font-semibold text-gray-400 mb-1"
              >Tracker Name</label
            >
            <input
              type="text"
              id="new-tracker-name"
              class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white outline-none focus:border-blue-500"
              placeholder="e.g. Gym Log"
            />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-400 mb-1"
              >Fields (Comma separated)</label
            >
            <input
              type="text"
              id="new-tracker-fields"
              class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white outline-none focus:border-blue-500"
              placeholder="e.g. Date, Exercise, Weight, Reps"
            />
            <p class="text-xs text-gray-500 mt-1">
              First field should usually be 'Date' or 'Name'
            </p>
          </div>

          <button
            onclick="createNewTracker()"
            class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold transition"
          >
            Create Tracker
          </button>
        </div>
      </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div
      id="settings-modal"
      class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center modal modal-hidden backdrop-blur-sm"
    >
      <div
        class="bg-gray-800 w-11/12 max-w-sm rounded-2xl p-6 shadow-2xl border border-gray-700"
      >
        <h3 class="text-lg font-bold text-white mb-2">Connect Google Sheet</h3>
        <p class="text-sm text-gray-400 mb-4">
          Paste the Web App URL from your Google Apps Script deployment.
        </p>

        <input
          type="url"
          id="inp-api-url"
          class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg mb-4 text-sm text-white focus:border-blue-500 outline-none"
          placeholder="https://script.google.com/macros/s/..."
        />

        <div class="flex justify-end gap-2">
          <button
            onclick="closeSettings()"
            class="px-4 py-2 text-gray-400 hover:text-white font-medium"
          >
            Cancel
          </button>
          <button
            onclick="saveSettings()"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700"
          >
            Save & Connect
          </button>
        </div>

        <div class="mt-6 pt-4 border-t border-gray-700">
          <button
            onclick="refreshSheetList()"
            class="w-full py-2 bg-gray-700 rounded text-sm mb-2 hover:bg-gray-600"
          >
            Re-fetch Sheet List
          </button>
          <button
            onclick="localStorage.clear(); location.reload()"
            class="text-red-500 text-xs w-full text-center hover:underline"
          >
            Reset App
          </button>
        </div>
      </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
      // --- STATE ---
      let APP_ = {
        sheets: [], // List of available sheets {name, headers[]}
        currentSheet: null, // The active sheet object
        data: [], // Data for current sheet
        apiUrl: localStorage.getItem("sheetSync_url") || "",
        editingId: null, // Track currently editing item ID
      };

      // --- INIT ---
      window.addEventListener("load", () => {
        if (!APP_.apiUrl) {
          openSettings();
        } else {
          loadMeta();
        }

        // Polling
        setInterval(() => {
          if (document.visibilityState === "visible" && APP_.currentSheet)
            loadData(APP_.currentSheet.name);
        }, 60000);
      });

      // --- ROUTING / VIEWS ---

      /* 1. DASHBOARD VIEW */
      function renderDashboard() {
        APP_.currentSheet = null;
        document.getElementById("btn-back").classList.add("hidden");
        document.getElementById("app-title").innerText = "SheetSync OS";

        const container = document.getElementById("main-container");
        container.innerHTML =
          '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 pb-20" id="app-grid"></div>';

        const grid = document.getElementById("app-grid");

        // Render App Cards
        APP_.sheets.forEach((sheet) => {
          let icon = "fa-table";
          let color = "bg-gray-800";

          // Simple heuristics for icons/colors
          const lower = sheet.name.toLowerCase();
          if (lower.includes("financ") || lower.includes("money")) {
            icon = "fa-wallet";
            color = "bg-blue-900/50 border-blue-800";
          } else if (lower.includes("habit")) {
            icon = "fa-check-circle";
            color = "bg-green-900/50 border-green-800";
          } else if (lower.includes("journal") || lower.includes("diary")) {
            icon = "fa-book";
            color = "bg-purple-900/50 border-purple-800";
          } else if (lower.includes("fitness") || lower.includes("gym")) {
            icon = "fa-dumbbell";
            color = "bg-orange-900/50 border-orange-800";
          }

          const card = `
             <div onclick="openTracker('${sheet.name}')" class="${color} border border-gray-700 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 aspect-square active:scale-95 transition cursor-pointer shadow-lg hover:shadow-xl hover:border-gray-500 group">
                <i class="fas ${icon} text-3xl text-gray-200 group-hover:text-white transition"></i>
                <span class="font-semibold text-sm text-center text-gray-300 group-hover:text-white">${sheet.name}</span>
             </div>
           `;
          grid.insertAdjacentHTML("beforeend", card);
        });

        // "Add New" Card
        const addCard = `
           <div onclick="openCreateTrackerModal()" class="bg-gray-800 border-2 border-dashed border-gray-700 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 aspect-square active:scale-95 transition cursor-pointer hover:border-gray-500 hover:bg-gray-750">
                <i class="fas fa-plus text-2xl text-gray-500"></i>
                <span class="font-semibold text-sm text-center text-gray-500">New Tracker</span>
           </div>
        `;
        grid.insertAdjacentHTML("beforeend", addCard);

        // Hide FAB on dashboard (using card instead)
        document.getElementById("fab").classList.add("hidden");
      }

      /* 2. TRACKER VIEW */
      async function openTracker(sheetName) {
        const sheet = APP_.sheets.find((s) => s.name === sheetName);
        if (!sheet) return;

        APP_.currentSheet = sheet;

        // UI Updates
        document.getElementById("btn-back").classList.remove("hidden");
        document.getElementById("app-title").innerText = sheet.name;
        document.getElementById("fab").classList.remove("hidden");

        const container = document.getElementById("main-container");
        container.innerHTML = `
            <div id="tracker-stats" class="mb-4"></div>
            <div id="tracker-list" class="space-y-3 pb-24">
                <div class="text-center py-10 text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
            </div>
        `;

        // Fetch Data
        await loadData(sheetName);
      }

      function renderTrackerData() {
        const container = document.getElementById("tracker-list");
        container.innerHTML = "";

        // Special Case: Finance View (if headers match typical finance structure)
        const headers = APP_.currentSheet.headers.map((h) => h.toLowerCase());
        const isFinance =
          headers.includes("amount") &&
          (headers.includes("type") || headers.includes("category"));

        if (APP_.data.length === 0) {
          container.innerHTML =
            '<div class="text-center py-10 text-gray-500">No entries yet.</div>';
          return;
        }

        // --- RENDER LOGIC ---
        APP_.data.forEach((item) => {
          let html = "";

          if (isFinance) {
            // Specialized Finance Card
            const isExp = (item.type || "").toLowerCase() === "expense";
            const color = isExp ? "text-red-400" : "text-green-400";
            const sign = isExp ? "-" : "+";

            html = `
                    <div class="bg-gray-800 p-3 rounded-xl border border-gray-700 shadow-sm flex items-center justify-between">
                        <div>
                             <p class="font-bold text-gray-200">${
                               item.category || "Unknown"
                             }</p>
                             <p class="text-xs text-gray-500">${
                               item.date || ""
                             } ${item.note ? "• " + item.note : ""}</p>
                        </div>
                        <p class="font-bold ${color}">${sign}₹${Number(
              item.amount
            ).toLocaleString()}</p>
                    </div>
                 `;
          } else {
            // Generic List Card
            // Find the "primary" field (first non-date field usually) for title, second for subtitle
            const keys = Object.keys(item);
            const h = APP_.currentSheet.headers;
            const titleKey = h[0]; // First column
            const subKey = h[1]; // Second column
            const valKey = h.length > 2 ? h[2] : null;

            html = `
                    <div class="bg-gray-800 p-3 rounded-xl border border-gray-700 shadow-sm flex items-center justify-between">
                        <div>
                             <p class="font-bold text-gray-200">${
                               item[titleKey] || "-"
                             }</p>
                             <p class="text-xs text-gray-500">${
                               item[subKey] || ""
                             }</p>
                        </div>
                        ${
                          valKey
                            ? `<p class="font-mono text-sm text-gray-300 bg-gray-700 px-2 py-1 rounded">${item[valKey]}</p>`
                            : ""
                        }
                    </div>
                 `;
          }
          container.insertAdjacentHTML("beforeend", html);
        });

        // Stats for finance
        if (isFinance) {
          const income = APP_.data
            .filter((i) => (i.type || "").toLowerCase() === "income")
            .reduce((s, i) => s + Number(i.amount), 0);
          const expense = APP_.data
            .filter((i) => (i.type || "").toLowerCase() === "expense")
            .reduce((s, i) => s + Number(i.amount), 0);

          document.getElementById("tracker-stats").innerHTML = `
               <div class="grid grid-cols-2 gap-3 mb-2">
                   <div class="bg-gray-800 p-3 rounded-xl border border-gray-700"><p class="text-xs text-gray-500 uppercase">Input</p><p class="text-lg font-bold text-green-400">₹${income}</p></div>
                   <div class="bg-gray-800 p-3 rounded-xl border border-gray-700"><p class="text-xs text-gray-500 uppercase">Output</p><p class="text-lg font-bold text-red-400">₹${expense}</p></div>
               </div>
               <div class="bg-gradient-to-r from-blue-900 to-gray-900 p-3 rounded-xl border border-blue-800 flex justify-between items-center">
                   <span class="text-blue-100 font-medium">Net Balance</span>
                   <span class="text-xl font-bold text-white">₹${
                     income - expense
                   }</span>
               </div>
            `;
        } else {
          document.getElementById("tracker-stats").innerHTML = "";
        }
      }

      function goHome() {
        renderDashboard();
      }

      // --- DATA OPERATIONS ---

      async function loadMeta() {
        updateStatus("Syncing Apps...", "yellow-400");
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 12000); // 12s timeout

        try {
          // 1. Get List of Sheets
          const res = await fetch(`${APP_.apiUrl}?action=get_sheets`, {
            signal: controller.signal,
          });
          clearTimeout(timeoutId);

          const json = await res.json();

          if (json.status === "success") {
            // VALIDATION: Check if response is from new backend
            if (
              Array.isArray(json.data) &&
              json.data.length > 0 &&
              !json.data[0].name
            ) {
              throw new Error(
                "Backend mismatch! Please Deploy a 'New Version' in Apps Script."
              );
            }

            APP_.sheets = json.data;
            localStorage.setItem("sheetSync_meta", JSON.stringify(APP_.sheets));
            renderDashboard();
            updateStatus("Ready", "green-400");
          } else {
            throw new Error(json.message || "Unknown API Error");
          }
        } catch (e) {
          console.error(e);
          updateStatus("Error", "red-400");

          let msg = e.message;
          if (e.name === "AbortError") msg = "Connection Timed Out";

          // Show visible alert for troubleshooting
          alert(
            `Connection Failed: ${msg}\n\nTip: Check Google Sheet permissions or 'Manage Deployments' > 'New Version'`
          );

          // Load from Cache if possible
          const cached = localStorage.getItem("sheetSync_meta");
          if (cached) {
            APP_.sheets = JSON.parse(cached);
            renderDashboard();
            updateStatus("Offline Mode", "gray-400");
          }
        }
      }

      async function loadData(sheetName) {
        updateStatus("Fetching Data...", "yellow-400");
        try {
          const res = await fetch(
            `${APP_.apiUrl}?action=read&sheet=${sheetName}`
          );
          const json = await res.json();
          if (json.status === "success") {
            // reverse for recent first
            APP_.data = json.data.reverse();
            renderTrackerData();
            updateStatus("Ready", "green-400");
          }
        } catch (e) {
          updateStatus("Offline (Read Error)", "red-400");
        }
      }

      async function createNewTracker() {
        const name = document.getElementById("new-tracker-name").value.trim();
        const fieldsStr = document
          .getElementById("new-tracker-fields")
          .value.trim();

        if (!name || !fieldsStr) return alert("Fill all fields");

        const headers = fieldsStr.split(",").map((s) => s.trim());
        // Always ensure 'id' represents a unique row if needed, but here user defines.
        // Ideally we might want to auto-inject 'id' or 'timestamp'.
        // For now, trust user.

        updateStatus("Creating Sheet...", "blue-400");
        document
          .getElementById("create-tracker-modal")
          .classList.add("modal-hidden");
        document
          .getElementById("create-tracker-modal")
          .classList.remove("modal-visible");

        try {
          const res = await fetch(APP_.apiUrl, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({
              action: "create_sheet",
              name: name,
              headers: headers,
            }),
          });

          // Wait a bit for propagation then reload
          setTimeout(() => {
            loadMeta();
            alert("Tracker created! It may take a few seconds to appear.");
          }, 2000);
        } catch (e) {
          alert("Error creating tracker: " + e.message);
        }
      }

      // --- DYNAMIC FORMS ---

      function handleFabClick() {
        if (!APP_.currentSheet) return;
        APP_.editingId = null; // Reset edit state
        buildForm(APP_.currentSheet.headers);
        document.getElementById("modal-title").innerText = "Add Entry";

        const m = document.getElementById("form-modal");
        m.classList.remove("modal-hidden");
        m.classList.add("modal-visible");
      }

      function handleItemClick(index) {
        if (!APP_.currentSheet) return;
        const item = APP_.data[index];
        APP_.editingId = item.id;

        buildForm(APP_.currentSheet.headers, item);
        document.getElementById("modal-title").innerText = "Edit Entry";

        const m = document.getElementById("form-modal");
        m.classList.remove("modal-hidden");
        m.classList.add("modal-visible");
      }

      function buildForm(headers, existingData) {
        const form = document.getElementById("dynamic-form");
        form.innerHTML = "";

        headers.forEach((h) => {
          const lower = h.toLowerCase();
          if (lower === "id") return; // Skip ID

          let inputType = "text";
          let html = "";

          const val = existingData ? existingData[h] || "" : "";

          // Infer type
          if (lower.includes("date")) inputType = "date";
          else if (
            lower.includes("amount") ||
            lower.includes("price") ||
            lower.includes("cost") ||
            lower === "reps" ||
            lower === "sets"
          )
            inputType = "number";

          // Special: Category or Type Select
          if (
            lower === "type" &&
            (APP_.currentSheet.name.toLowerCase().includes("financ") ||
              APP_.currentSheet.name.toLowerCase().includes("money"))
          ) {
            const selExp = val === "Expense" ? "selected" : "";
            const selInc = val === "Income" ? "selected" : "";
            html = `
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 mb-1 capitalize">${h}</label>
                        <select name="${h}" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white outline-none">
                            <option ${selExp}>Expense</option>
                            <option ${selInc}>Income</option>
                        </select>
                    </div>`;
          } else {
            // Standard Input
            html = `
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 mb-1 capitalize">${h}</label>
                        <input type="${inputType}" name="${h}" value="${val}" step="any" required class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white outline-none focus:border-blue-500">
                    </div>
                 `;
          }
          form.insertAdjacentHTML("beforeend", html);
        });

        const btnText = existingData ? "Update Entry" : "Save Entry";
        form.insertAdjacentHTML(
          "beforeend",
          `<button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold mt-2">${btnText}</button>`
        );
      }

      async function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = {};

        // Collect data
        APP_.currentSheet.headers.forEach((h) => {
          if (h.toLowerCase() === "id") {
            data[h] = APP_.editingId || crypto.randomUUID();
          } else {
            data[h] = formData.get(h);
          }
        });

        closeFormModal();

        // Optimistic UI
        if (APP_.editingId) {
          const idx = APP_.data.findIndex((d) => d.id === APP_.editingId);
          if (idx !== -1) APP_.data[idx] = data;
        } else {
          APP_.data.unshift(data);
        }

        renderTrackerData();

        // Sync
        updateStatus("Saving...", "blue-400");
        try {
          const action = APP_.editingId ? "update" : "add";
          const res = await fetch(APP_.apiUrl, {
            method: "POST",
            // mode: "no-cors", // Removed to see errors
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
              action: action,
              sheet: APP_.currentSheet.name,
              data: data,
            }),
          });

          const text = await res.text();
          let json = null;
          try {
            json = JSON.parse(text);
          } catch (e) {
            // If not JSON, it's likely an HTML error page (Auth/404)
            throw new Error(
              "Invalid Server Response. Check URL & Permissions. Response: " +
                text.substring(0, 50) +
                "..."
            );
          }

          if (json.status === "error") {
            throw new Error(json.message || "Unknown Server Error");
          }

          // Reconfirm
          setTimeout(() => loadData(APP_.currentSheet.name), 1000);
          updateStatus("Saved", "green-400");
        } catch (err) {
          console.error(err);
          alert("Error syncing: " + err.message);
          updateStatus("Error", "red-400");
        }
      }

      // --- HELPERS & MODALS ---
      function updateStatus(text, color) {
        document.getElementById(
          "status-indicator"
        ).innerHTML = `<i class="fas fa-circle text-[8px] mr-1 text-${color}"></i> ${text}`;
      }
      function openSettings() {
        document.getElementById("inp-api-url").value = APP_.apiUrl;
        const m = document.getElementById("settings-modal");
        m.classList.remove("modal-hidden");
        m.classList.add("modal-visible");
      }
      function closeSettings() {
        document
          .getElementById("settings-modal")
          .classList.remove("modal-visible");
        document.getElementById("settings-modal").classList.add("modal-hidden");
      }
      function saveSettings() {
        const url = document.getElementById("inp-api-url").value.trim();
        if (url) {
          localStorage.setItem("sheetSync_url", url);
          APP_.apiUrl = url;
          closeSettings();
          loadMeta();
        }
      }
      function refreshSheetList() {
        closeSettings();
        loadMeta();
      }
      function closeFormModal() {
        document.getElementById("form-modal").classList.remove("modal-visible");
        document.getElementById("form-modal").classList.add("modal-hidden");
      }
      function openCreateTrackerModal() {
        const m = document.getElementById("create-tracker-modal");
        m.classList.remove("modal-hidden");
        m.classList.add("modal-visible");
      }
    </script>
  </body>
</html>
